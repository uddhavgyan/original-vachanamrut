<div class="vachanamrut-tabs">
  <!-- Main Tab Buttons -->
  <div class="main-tab-buttons">
    <button class="active" data-section="harivakya" id="main-tab-harivakya" onclick="openMainTab(event, 'harivakya')">
      શ્રીહરિવાક્યસુધાસિંધુ
    </button>
    <button data-section="setumala" id="main-tab-setumala" onclick="openMainTab(event, 'setumala')">
      સેતુમાળા ટીકા
    </button>
  </div>

  <!-- Harivakya (Shri Harivakyasudha Sindhu) Section -->
  <div id="harivakya" class="main-tab-content active">
    <h2 id="harivakya-header">
      શ્રીહરિવાક્યસુધાસિંધુ - સદ્‍ગુરુ શ્રી શતાનંદ સ્વામી દ્વારા રચિત સંસ્કૃત રૂપાંતરણ
    </h2>
    
    <div class="sub-tabs">
      <button class="active" data-lang="sa" onclick="openSubTab(event, 'hs-sa', 'harivakya')">संस्कृत</button>
      <button data-lang="gu" onclick="openSubTab(event, 'hs-gu', 'harivakya')">ગુજરાતી</button>
      <button data-lang="hi" onclick="openSubTab(event, 'hs-hi', 'harivakya')">हिंदी</button>
      <button data-lang="en" onclick="openSubTab(event, 'hs-en', 'harivakya')">English</button>
    </div>

    <!-- Language Contents for Harivakya -->
    <div id="hs-sa" class="sub-tab-content active lang-sa">
      {{ $hs_sa := .Page.Resources.GetMatch "hs-sa.md" }}
      {{ if $hs_sa }}{{ $hs_sa.Content | safeHTML }}{{ else }}
        <p style="text-align:center; color:#666; padding:2rem;">
          સંસ્કૃત રૂપાંતરણ હાલમાં ઉપલબ્ધ નથી. ટૂંક સમયમાં આવશે...
        </p>
      {{ end }}
    </div>
    <div id="hs-gu" class="sub-tab-content lang-gu">
      {{ $hs_gu := .Page.Resources.GetMatch "hs-gu.md" }}
      {{ if $hs_gu }}{{ $hs_gu.Content | safeHTML }}{{ else }}
        <p style="text-align:center; color:#666; padding:2rem;">ગુજરાતી કન્ટેન્ટ આવી રહ્યું છે...</p>
      {{ end }}
    </div>
    <div id="hs-hi" class="sub-tab-content lang-hi">
      {{ $hs_hi := .Page.Resources.GetMatch "hs-hi.md" }}
      {{ if $hs_hi }}{{ $hs_hi.Content | safeHTML }}{{ else }}
        <p style="text-align:center; color:#666; padding:2rem;">हिंदी कंटेंट आ रहा है...</p>
      {{ end }}
    </div>
    <div id="hs-en" class="sub-tab-content lang-en">
      {{ $hs_en := .Page.Resources.GetMatch "hs-en.md" }}
      {{ if $hs_en }}{{ $hs_en.Content | safeHTML }}{{ else }}
        <p style="text-align:center; color:#666; padding:2rem;">English content coming soon...</p>
      {{ end }}
    </div>
  </div>

  <!-- Setumala Tika Section -->
  <div id="setumala" class="main-tab-content">
    <h2 id="setumala-header">
      સેતુમાળા ટીકા - પ્રથમ આચાર્ય શ્રી રઘુવીરજી મહારાજ દ્વારા રચિત સંસ્કૃત ટીકા
    </h2>
    
    <div class="sub-tabs">
      <button class="active" data-lang="sa" onclick="openSubTab(event, 'st-sa', 'setumala')">संस्कृत</button>
      <button data-lang="gu" onclick="openSubTab(event, 'st-gu', 'setumala')">ગુજરાતી</button>
      <button data-lang="hi" onclick="openSubTab(event, 'st-hi', 'setumala')">हिंदी</button>
      <button data-lang="en" onclick="openSubTab(event, 'st-en', 'setumala')">English</button>
    </div>

    <!-- Language Contents for Setumala -->
    <div id="st-sa" class="sub-tab-content active lang-sa">
      {{ $st_sa := .Page.Resources.GetMatch "st-sa.md" }}
      {{ if $st_sa }}{{ $st_sa.Content | safeHTML }}{{ else }}
        <p style="text-align:center; color:#666; padding:2rem;">સંસ્કૃત ટીકા આવી રહી છે...</p>
      {{ end }}
    </div>
    <div id="st-gu" class="sub-tab-content lang-gu">
      {{ $st_gu := .Page.Resources.GetMatch "st-gu.md" }}
      {{ if $st_gu }}{{ $st_gu.Content | safeHTML }}{{ else }}
        <p style="text-align:center; color:#666; padding:2rem;">ગુજરાતી ટીકા આવી રહી છે...</p>
      {{ end }}
    </div>
    <div id="st-hi" class="sub-tab-content lang-hi">
      {{ $st_hi := .Page.Resources.GetMatch "st-hi.md" }}
      {{ if $st_hi }}{{ $st_hi.Content | safeHTML }}{{ else }}
        <p style="text-align:center; color:#666; padding:2rem;">હિન્દી ટીકા આવી રહી છે...</p>
      {{ end }}
    </div>
    <div id="st-en" class="sub-tab-content lang-en">
      {{ $st_en := .Page.Resources.GetMatch "st-en.md" }}
      {{ if $st_en }}{{ $st_en.Content | safeHTML }}{{ else }}
        <p style="text-align:center; color:#666; padding:2rem;">English commentary coming soon...</p>
      {{ end }}
    </div>
  </div>
</div>

<script>
// ==================================================================
// 1. Translation Data – Text for different languages
// ==================================================================
// This object holds translated text for:
// - Main tab button labels
// - Header (<h2>) text
// When user selects Gujarati/Hindi/English, these texts replace the default Gujarati ones.
// When Sanskrit is selected, it always falls back to original Gujarati text.
const translations = {
  mainTabs: {
    harivakya: {
      gu: "શ્રીહરિવાક્યસુધાસિંધુ",
      hi: "श्रीहरिवाक्यसुधासिन्धु",
      en: "Shri Harivakyasudha Sindhu"
    },
    setumala: {
      gu: "સેતુમાળા ટીકા",
      hi: "सेतुमाला टीका",
      en: "Setumala Tika"
    }
  },
  headers: {
    harivakya: {
      gu: "શ્રીહરિવાક્યસુધાસિંધુ - સદ્‍ગુરુ શ્રી શતાનંદ સ્વામી દ્વારા રચિત સંસ્કૃત રૂપાંતરણ",
      hi: "श्रीहरिवाक्यसुधासिन्धु - सद्गुरु श्री शतानन्द स्वामीजी द्वारा रचित संस्कृत रूपान्तरण",
      en: "Shri Harivakyasudha Sindhu - Sanskrit rendition composed by Sadguru Shatanand Swami"
    },
    setumala: {
      gu: "સેતુમાળા ટીકા - પ્રથમ આચાર્ય શ્રી રઘુવીરજી મહારાજ દ્વારા રચિત સંસ્કૃત ટીકા",
      hi: "सेतुमाला टीका - प्रथम आचार्य श्री रघुवीरजी महाराज द्वारा रचित संस्कृत टीका",
      en: "Setumala Tika - Sanskrit commentary by 1st Acharya Shri Raghuvirji Maharaj"
    }
  }
};

// Mapping: which prefix to use for content IDs (hs = harivakya sanskrit/guj etc., st = setumala)
const sectionPrefix = {
  harivakya: 'hs',
  setumala: 'st'
};

// ==================================================================
// 2. openMainTab – Called when user clicks a main tab button
// ==================================================================
// Purpose: Switch between main sections (Harivakya ↔ Setumala)
// - Hides all main content divs
// - Removes 'active' from all main buttons
// - Shows selected tab and marks its button active
// - Updates URL with current tab & language
function openMainTab(evt, tabName) {
  document.querySelectorAll('.main-tab-content').forEach(tab => tab.classList.remove('active'));
  document.querySelectorAll('.main-tab-buttons button').forEach(btn => btn.classList.remove('active'));

  const tabElement = document.getElementById(tabName);
  const btnElement = document.getElementById(`main-tab-${tabName}`);
  if (tabElement) tabElement.classList.add('active');
  if (btnElement) btnElement.classList.add('active');

  const currentLang = getCurrentLang(tabName);
  updateURL(tabName, currentLang);
}

// ==================================================================
// 3. openSubTab – Called when user clicks a language button
// ==================================================================
// Purpose: Switch language inside the current main tab
// - Hides all language content in current section
// - Removes 'active' from all language buttons
// - Shows selected language content and marks button active
// - Updates main tab button text and header using translations
// - Updates URL with current tab & language
function openSubTab(evt, tabName, section) {
  const parent = evt.currentTarget.closest('.main-tab-content');
  if (!parent) return;

  parent.querySelectorAll('.sub-tab-content').forEach(c => c.classList.remove('active'));
  parent.querySelectorAll('.sub-tabs button').forEach(b => b.classList.remove('active'));

  const content = document.getElementById(tabName);
  if (content) content.classList.add('active');

  evt.currentTarget.classList.add('active');

  const lang = evt.currentTarget.getAttribute('data-lang');
  updateTexts(section, lang);
  updateURL(section, lang);
}

// ==================================================================
// 4. updateTexts – Changes tab button and header text based on language
// ==================================================================
// Called after language change
// - If language is not Sanskrit → use translated text (from translations object)
// - If Sanskrit → always use original Gujarati text
function updateTexts(section, lang) {
  const mainBtn = document.getElementById(`main-tab-${section}`);
  const header = document.getElementById(`${section}-header`);
  if (!mainBtn || !header) return;

  if (lang !== 'sa') {
    mainBtn.textContent = translations.mainTabs[section][lang] || translations.mainTabs[section].gu;
    header.textContent = translations.headers[section][lang] || translations.headers[section].gu;
  } else {
    mainBtn.textContent = translations.mainTabs[section].gu;
    header.textContent = translations.headers[section].gu;
  }
}

// ==================================================================
// 5. getCurrentLang – Helper to find currently active language
// ==================================================================
// Used when switching main tabs to preserve the selected language
function getCurrentLang(section) {
  const btn = document.querySelector(`#${section} .sub-tabs button.active`);
  return btn ? btn.getAttribute('data-lang') : 'sa';
}

// ==================================================================
// 6. updateURL – Updates browser URL with current tab & language
// ==================================================================
// Uses replaceState() → changes URL without adding to history or reloading page
// Example: ?tab=setumala&lang=hi
function updateURL(tab, lang) {
  const url = new URL(window.location);
  url.searchParams.set('tab', tab);
  url.searchParams.set('lang', lang);
  window.history.replaceState({}, '', url);
}

// ==================================================================
// 7. restoreStateFromURL – Main function to restore UI from URL
// ==================================================================
// Runs on page load and browser back/forward
// - Reads ?tab= and ?lang= from URL
// - Falls back to harivakya + Sanskrit if invalid/missing
// - Activates correct main tab
// - Tries to show requested language content
// - If requested language file is missing → falls back to Sanskrit
// - Updates texts and URL to match final state
function restoreStateFromURL() {
  const params = new URLSearchParams(window.location.search);
  let tab = params.get('tab') || 'harivakya';
  let lang = params.get('lang') || 'sa';

  if (!document.getElementById(tab)) {
    tab = 'harivakya';
    lang = 'sa';
  }

  openMainTab(null, tab);

  const prefix = sectionPrefix[tab];
  const targetId = `${prefix}-${lang}`;
  const fallbackId = `${prefix}-sa`;

  const subButton = document.querySelector(`#${tab} .sub-tabs button[data-lang="${lang}"]`);
  const subContent = document.getElementById(targetId) || document.getElementById(fallbackId);

  const parent = document.getElementById(tab);
  if (!parent) return;

  parent.querySelectorAll('.sub-tab-content').forEach(c => c.classList.remove('active'));
  parent.querySelectorAll('.sub-tabs button').forEach(b => b.classList.remove('active'));

  if (subContent) subContent.classList.add('active');

  if (subButton && document.getElementById(targetId)) {
    subButton.classList.add('active');
  } else {
    const sanskritBtn = parent.querySelector('.sub-tabs button[data-lang="sa"]');
    if (sanskritBtn) sanskritBtn.classList.add('active');
    lang = 'sa';
  }

  updateTexts(tab, lang);
  updateURL(tab, lang);
}

// ==================================================================
// 8. Page Load – Start everything
// ==================================================================
// Restores state when page loads
// Also listens for back/forward button presses
document.addEventListener('DOMContentLoaded', () => {
  restoreStateFromURL();
  window.addEventListener('popstate', restoreStateFromURL);
});
</script>

<!-- ================================================================== -->
<!-- 9. Preserve Tab State When Navigating to Other Chapters -->
<!-- ================================================================== -->
<!-- This script automatically adds a class to all internal links -->
<!-- When clicked, it appends the current ?tab=...&lang=... to the new URL -->
<!-- So when user goes to another Vachanamrut/Partharo, same tab & language is kept -->
<script>
document.querySelectorAll('a[href^="/"], a[href^="./"], a[href^="#"]').forEach(link => {
  // Only internal links (same domain or relative)
  if (!link.host || link.host === window.location.host) {
    link.classList.add('preserve-query-link');
  }
});

document.addEventListener('click', function(e) {
  const clickedLink = e.target.closest('.preserve-query-link');
  if (clickedLink) {
    e.preventDefault();
    const target = clickedLink.getAttribute('href');
    const currentSearch = window.location.search; // e.g., ?tab=setumala&lang=hi
    window.location.href = target + currentSearch;
  }
});
</script>